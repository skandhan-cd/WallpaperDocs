<#
.SYNOPSIS
    Enforce Lock Screen & Logon Screen Wallpaper (Windows 10/11 Pro)
 
.DESCRIPTION
    - Forces wallpaper immediately.
    - Persists via scheduled task (runs at startup).
    - Blocks user personalization.
#>

Write-Output "Downloading IMG from Repo"

$ImgCDurl = "https://raw.githubusercontent.com/skandhan-cd/WallpaperDocs/main/WallpaperImg/LockScreenWallpaper/Wall%20paper%20Lock%20Screen%202.jpg"
$folderPath = "C:\ProgramData\FleetMDM\Wallpaper\"
if (-not (Test-Path -Path $folderPath -PathType Container)) {
    # If the folder does not exist, create it
    New-Item -Path $folderPath -ItemType Directory | Out-Null
    Write-Host "Folder created successfully: $folderPath"
} else {
    # If the folder already exists, inform the user
    Write-Host "Folder already exists: $folderPath"
}

$Img = "C:\ProgramData\FleetMDM\Wallpaper\CDSmilyImg.png"

$Ic = New-Object system.net.webclient
$Ic.DownloadFile($ImgCDurl, $Img)

Write-Output "File downloaded to $img"


# ==== 1. Validate ====
if (!(Test-Path $img)) {
    Write-Output "Wallpaper not found at $img"
    exit 1
}
 
# ==== 2. Enforce Logon Screen Background ====
Write-Output "Enforcing logon screen background..."
$SystemRegPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
if (!(Test-Path $SystemRegPath)) {
    New-Item -Path $SystemRegPath -Force | Out-Null
}
# 0 = enable background image
Set-ItemProperty -Path $SystemRegPath -Name "DisableLogonBackgroundImage" -Value 0 -Type DWord
Write-Output "Logon background enabled."

# ==== 3. Block User Personalization of Lock Screen ====
Write-Output "Blocking lock screen personalization..."
$UserRegPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\System"
if (!(Test-Path $UserRegPath)) {
    New-Item -Path $UserRegPath -Force | Out-Null
}

Set-ItemProperty -Path $UserRegPath -Name "NoDispScrSavPage" -Value 1 -Type DWord
Write-Output "User personalization disabled."

# ==== 4. Apply Lock Screen Immediately ====
Write-Output "Forcing lock screen wallpaper now..."
$CSPPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"
if (!(Test-Path $CSPPath)) {
    New-Item -Path $CSPPath -Force | Out-Null
}

Set-ItemProperty -Path $CSPPath -Name "LockScreenImagePath" -Value $img -Type String
Set-ItemProperty -Path $CSPPath -Name "LockScreenImageStatus" -Value 1 -Type DWord
Set-ItemProperty -Path $CSPPath -Name "LockScreenImageUrl" -Value $img -Type String
Write-Output "Lock screen wallpaper applied immediately."

# ==== 5. Scheduled Task for Persistence ====
Write-Output "Creating scheduled task to re-apply at startup..."
 
$Action = New-ScheduledTaskAction -Execute "powershell.exe" `
    -Argument "-NoProfile -WindowStyle Hidden -Command `"Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP' -Name LockScreenImagePath -Value '$img' -Type String; Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP' -Name LockScreenImageStatus -Value 1 -Type DWord; Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP' -Name LockScreenImageUrl -Value '$img' -Type String`""
 
$Trigger = New-ScheduledTaskTrigger -AtStartup
$Principal = New-ScheduledTaskPrincipal -GroupId "Users" -RunLevel Highest
$Task = New-ScheduledTask -Action $Action -Trigger $Trigger -Principal $Principal
 
Register-ScheduledTask -TaskName "EnforceLockScreenWallpaper" -InputObject $Task -Force
 
Write-Output "Scheduled task created."

# ==== 6. Force Refresh Now ====
gpupdate /force | Out-Null
Write-Output "Done! Lock screen & logon wallpaper enforced immediately and will persist after reboot."
